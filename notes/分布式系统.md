# 分布式系统

## 1. 分布式系统基本概念

### 1. CAP理论基础

分布式系统最大难点：各个节点之间的状态怎样保持同步。1998年，加州大学的计算机科学家Eric Brewer提出CAP，即分布式系统的三个指标：

> - Consistency（一致性）：所有节点访问同一份最新的数据副本，或者说同一数据在同一时刻在不同的节点上的副本应该是相同的内容。
> - Availability （可用性）：每次请求都能获取到正确的响应，以及较低的时延（不能保证获取到的数据都是最新的）
> - Partition tolerance （分区容错性）：任意节点故障时，系统仍然可以对外服务。（这就导致在节点故障时，系统必须在一致性和可用性之间做出平衡）

### 2. 数据一致性（consistency）

一些分布式系统通过复制数据（创建数据副本）来提高系统的可靠性，并且将数据的不同副本放在不同的节点上。因此，数据的一致性便显得尤为关键，相关的一致性模型也陆续提出：

- **强一致性**：无论何时在哪个节点上，对数据进行了更新操作，后续的读操作都能获取到最新的数据。
- **弱一致性**：数据更新操作之后，并不会立即同步到所有节点上，也就是需要一段时间才能同步所有数据，这段时间也称为“不一致窗口”。
- **最终一致性**：弱一致性的一种，允许系统在某个时间窗口内不一致，但最终是要靠一些机制保证数据的一致性（比如，通过比较时间戳，判断是否要进行更新数据）

一般来说，维护数据副本的一致性代价比较大，因此许多系统采用**弱一致性**来提高性能。常见的一致性解决方案有：

1. 分布式事务：
2. 分布式锁
3. 消息队列、消息持久化、重试、幂等操作（多次执行同一操作和执行一次的效果一样）
4. Raft/Paxos等一致性算法

TODO: 重点看一下分布式锁和消息队列（Kafka）

### 3. 服务可用性（availability）

可用性，简单说，用户请求，系统必须给出响应

常见高可用性解决方案：

- 负载均衡：尽量将网络流量平均分发到多个服务器上，以提高系统整体的响应速度和可用性。
- 降级：当服务器压力剧增的情况下，根据当前的业务情况及流量，对当前的一些服务和页面有策略地降级，以此释放服务器资源以保持核心任务的正常运行。
- 熔断：对于目标服务，有大量的请求导致大量的超时和失败，应该熔断该服务的所有调用，对于后续调用应该直接返回，快速释放资源。
- 流量控制：流量控制可以有效防止网络上瞬间大量的数据导致的冲击，保证用户网络高效而稳定地运行，类似TCP的拥塞控制。
- 异地多活：在不同地区维护不同子系统，并保证子系统的可用性。

NOTE：熔断是减少下游服务故障对自己的影响，而降级则是在整个系统的角度，考虑业务整体流量，保护核心业务稳定。

### 4. 分区容错性（partition tolerance）

大多数分布式系统都分布在多个子网络。每个字网络就叫一个区。分区容错指区间通信可能失败，比如一台服务器在上海，一台服务器在新加坡，两台服务器可能因为网络而无法通信。

一般来说，分区容错无法避免，因此可以认为CAP中的`P`总是成立，而剩下的`C`和`A`无法同时做到。

